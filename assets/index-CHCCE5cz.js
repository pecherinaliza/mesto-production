(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const s of c.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(n){if(n.ep)return;n.ep=!0;const c=o(n);fetch(n.href,c)}})();const Q=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),A=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:r})=>{const n=Q(),c=n.querySelector(".card__like-button"),s=n.querySelector(".card__control-button_type_delete"),a=n.querySelector(".card__image");return a.src=e.link,a.alt=e.name,n.querySelector(".card__title").textContent=e.name,o&&c.addEventListener("click",()=>o(c)),r&&s.addEventListener("click",()=>r(n)),t&&a.addEventListener("click",()=>t({name:e.name,link:e.link})),n},W=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");p(t)}},_=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",W)},p=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",W)},X=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{p(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&p(e)})},N=(e,t)=>{e.disabled=!0,e.classList.add(t)},Y=(e,t)=>{e.disabled=!1,e.classList.remove(t)},Z=e=>!e.every(t=>t.validity.valid),P=(e,t,o)=>{Z(e)?N(t,o):Y(t,o)},ee=(e,t,o,r,n)=>{const c=e.querySelector(`#${t.id}-error`);t.classList.toggle(o,!0),c.textContent=r,c.classList.toggle(n,!0)},j=(e,t,o,r)=>{const n=e.querySelector(`#${t.id}-error`);t.classList.toggle(o,!1),n.textContent="",n.classList.toggle(r,!1)},te=(e,t,o,r)=>{const{validity:n,dataset:c}=t;if(n.patternMismatch){const s=n.tooShort?`Поле должно содержать от ${t.minLength} до ${t.maxLength} символов.`:c.errorMessage;t.setCustomValidity(s)}else t.setCustomValidity("");n.valid?j(e,t,o,r):ee(e,t,o,t.validationMessage,r)},oe=(e,t,o,r,n,c)=>{const s=[...e.querySelectorAll(t)],a=u=>{te(e,u.target,o,r),P(s,n,c)};s.forEach(u=>u.addEventListener("input",a)),P(s,n,c)},ne=e=>{const{formSelector:t,inputSelector:o,submitButtonSelector:r,inactiveButtonClass:n,inputErrorClass:c,errorClass:s}=e;document.querySelectorAll(t).forEach(a=>{const u=a.querySelector(r),i=[...a.querySelectorAll(o)];P(i,u,n),oe(a,o,c,s,u,n)})},I=(e,t)=>{const{inputSelector:o,submitButtonSelector:r,inactiveButtonClass:n,inputErrorClass:c,errorClass:s}=t,a=e.querySelector(r);[...e.querySelectorAll(o)].forEach(i=>j(e,i,c,s)),N(a,n)},l={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"b37f2fca-2fd4-44c4-9ef1-8cd7ddabd00d","Content-Type":"application/json"}},d=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),D=()=>fetch(`${l.baseUrl}/users/me`,{headers:l.headers}).then(d),H=()=>fetch(`${l.baseUrl}/cards`,{headers:l.headers}).then(d),re=({name:e,about:t})=>fetch(`${l.baseUrl}/users/me`,{method:"PATCH",headers:l.headers,body:JSON.stringify({name:e,about:t})}).then(d),ce=({avatar:e})=>fetch(`${l.baseUrl}/users/me/avatar`,{method:"PATCH",headers:l.headers,body:JSON.stringify({avatar:e})}).then(d),se=({name:e,link:t})=>fetch(`${l.baseUrl}/cards`,{method:"POST",headers:l.headers,body:JSON.stringify({name:e,link:t})}).then(d),ie=({cardId:e})=>fetch(`${l.baseUrl}/cards/${e}`,{method:"DELETE",headers:l.headers,body:JSON.stringify({cardId:e})}).then(d),le=(e,t)=>fetch(`${l.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:l.headers}).then(o=>d(o)),J=document.querySelector(".places__list"),g=document.querySelector(".popup_type_edit"),E=g.querySelector(".popup__button"),q=g.querySelector(".popup__form"),V=q.querySelector(".popup__input_type_name"),z=q.querySelector(".popup__input_type_description"),w=document.querySelector(".popup_type_remove-card"),h=w.querySelector(".popup__button"),L=document.querySelector(".popup_type_new-card"),k=L.querySelector(".popup__button"),m=L.querySelector(".popup__form"),ae=m.querySelector(".popup__input_type_card-name"),ue=m.querySelector(".popup__input_type_url"),B=document.querySelector(".popup_type_image"),$=B.querySelector(".popup__image"),pe=B.querySelector(".popup__caption"),de=document.querySelector(".profile__edit-button"),_e=document.querySelector(".profile__add-button"),M=document.querySelector(".profile__title"),U=document.querySelector(".profile__description"),T=document.querySelector(".profile__image"),C=document.querySelector(".popup_type_edit-avatar"),x=C.querySelector(".popup__button"),v=C.querySelector(".popup__form"),me=v.querySelector(".popup__input"),ye=document.querySelector(".header__logo"),y=document.querySelector(".popup_type_info"),fe=y.querySelector(".popup__title"),he=y.querySelector(".popup__text"),F=y.querySelector(".popup__info"),O=y.querySelector(".popup__list"),Se=document.querySelector("#popup-info-definition-template").content,ve=document.querySelector("#popup-info-user-preview-template").content,b={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};ne(b);const K=(e,t)=>{_(w),h.addEventListener("click",function(o){h.textContent="Удаление...",o.preventDefault(),ie({cardId:t}).then(()=>{e.remove(),p(w),h.textContent="Да"}).catch(r=>{console.log(r),h.textContent="Да"})})},R=(e,t)=>{le(t,e.classList.contains("card__like-button_is-active")).then(o=>{o.likes.length>0?e.parentElement.querySelector(".card__like-count").textContent=o.likes.length:e.parentElement.querySelector(".card__like-count").textContent="",e.classList.toggle("card__like-button_is-active")}).catch(o=>{console.log(o)})},G=({name:e,link:t})=>{$.src=t,$.alt=e,pe.textContent=e,_(B)},ge=e=>{e.preventDefault(),E.textContent="Сохранение...",re({name:V.value,about:z.value}).then(t=>{M.textContent=t.name,U.textContent=t.about,p(g),E.textContent="Сохранить"}).catch(t=>{console.log(t),E.textContent="Сохранить"})},qe=e=>{e.preventDefault(),x.textContent="Сохранение...",ce({avatar:me.value}).then(t=>{T.style.backgroundImage=`url(${t.avatar})`,p(C),x.textContent="Сохранить"}).catch(t=>{console.log(t),x.textContent="Сохранить"})},Le=e=>{e.preventDefault(),k.textContent="Создание...",se({name:ae.value,link:ue.value}).then(t=>{J.prepend(A({name:t.name,link:t.link},{onPreviewPicture:G,onLikeIcon:o=>{R(o,t._id)},onDeleteCard:o=>{K(o,t._id)}})),k.textContent="Создать",p(L)}).catch(t=>{console.log(t),k.textContent="Создать"})},S=(e,t)=>{const o=Se.cloneNode(!0);return o.querySelector(".popup__info-term").textContent=e,o.querySelector(".popup__info-description").textContent=t,o},Ce=e=>{const t=ve.cloneNode(!0);return t.querySelector(".popup__list-item").textContent=e,t},be=()=>{Promise.all([H(),D()]).then(([e,t])=>{fe.textContent="Статистика карточек",F.innerHTML="",O.innerHTML="",he.textContent="Популярные карточки:";const o=new Map;e.forEach(i=>{o.has(i.owner._id)||o.set(i.owner._id,i.owner.name)});let r=0;const n={};e.forEach(i=>{i.likes.forEach(f=>{r+=1,n[f._id]=(n[f._id]||0)+1})});const c=Math.max(...Object.values(n),0),s=Object.keys(n).find(i=>n[i]===c),a=o.get(s)||t.name;F.append(S("Всего пользователей:",o.size),S("Всего лайков:",r),S("Максимально лайков от одного:",c),S("Чемпион лайков:",a)),[...e].sort((i,f)=>f.likes.length-i.likes.length).slice(0,3).forEach(i=>{O.append(Ce(i.name))}),_(y)}).catch(e=>{console.log(e)})};q.addEventListener("submit",ge);m.addEventListener("submit",Le);v.addEventListener("submit",qe);de.addEventListener("click",()=>{V.value=M.textContent,z.value=U.textContent,_(g),I(q,b)});T.addEventListener("click",()=>{v.reset(),_(C),I(v,b)});_e.addEventListener("click",()=>{m.reset(),_(L),I(m,b)});ye.addEventListener("click",be);const Ee=document.querySelectorAll(".popup");Ee.forEach(e=>{X(e)});Promise.all([H(),D()]).then(([e,t])=>{e.forEach(o=>{const r=A(o,{onPreviewPicture:G,onLikeIcon:n=>{R(n,o._id)},onDeleteCard:n=>{K(n,o._id)}});J.append(r),o.owner._id!==t._id&&r.querySelector(".card__control-button_type_delete").remove(),o.likes.length>0?r.querySelector(".card__like-count").textContent=o.likes.length:r.querySelector(".card__like-count").textContent="",o.likes.flat().find(n=>n._id===t._id)?r.querySelector(".card__like-button").classList.add("card__like-button_is-active"):r.querySelector(".card__like-button").classList.remove("card__like-button_is-active")}),M.textContent=t.name,U.textContent=t.about,T.style.backgroundImage=`url(${t.avatar})`}).catch(e=>{console.log(e)});
